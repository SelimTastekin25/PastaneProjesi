@model PastaneProjesi.Models.Product

@{
    ViewData["Title"] = Model.Name;
}

<div class="container my-5">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-4">
            <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index" class="text-decoration-none text-muted">Anasayfa</a></li>
            <li class="breadcrumb-item"><a asp-controller="Shop" asp-action="Index" class="text-decoration-none text-muted">Ürünler</a></li>
            <li class="breadcrumb-item active" aria-current="page">@Model.Name</li>
        </ol>
    </nav>

    <div class="row g-5">
        <!-- Product Image -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                @if (!string.IsNullOrEmpty(Model.ImageUrl))
                {
                    <img src="@Model.ImageUrl" class="img-fluid w-100 object-fit-cover" style="height: 500px;" alt="@Model.Name">
                }
                else
                {
                    <div class="bg-light d-flex align-items-center justify-content-center" style="height: 500px;">
                        <i class="fas fa-image fa-5x text-muted opacity-25"></i>
                    </div>
                }
            </div>
        </div>

        <!-- Product Details -->
        <div class="col-lg-6 d-flex flex-column justify-content-center">
            <h6 class="text-uppercase fw-bold text-muted mb-2">@Model.Category?.Name</h6>
            <h1 class="display-4 fw-bold mb-3" style="font-family: 'Playfair Display', serif; color: var(--color-warm-chocolate);">@Model.Name</h1>
            
            <p class="lead fw-bold text-warning mb-4 fs-2" style="font-family: 'Poppins', sans-serif;">
                @Model.Price.ToString("C2", new System.Globalization.CultureInfo("tr-TR"))
            </p>

            <p class="text-muted mb-5 fs-5" style="line-height: 1.8;">
                @(string.IsNullOrEmpty(Model.Description) ? "Bu ürün için henüz bir açıklama eklenmedi." : Model.Description)
            </p>

            <div class="d-flex gap-3 mb-5">
                <div class="d-flex align-items-center bg-light rounded-pill px-3 border">
                     <i class="fas fa-check-circle text-success me-2"></i>
                     <span class="text-muted small fw-bold">Stokta: @Model.Stock adet</span>
                </div>
                <div class="d-flex align-items-center bg-light rounded-pill px-3 border">
                     <i class="fas fa-shipping-fast text-primary me-2"></i>
                     <span class="text-muted small fw-bold">Hızlı Teslimat</span>
                </div>
            </div>

            <!-- Add to Cart Form -->
            <form onsubmit="addToCart(event, this)" asp-controller="Cart" asp-action="AddToCart" method="post">
                <input type="hidden" name="productId" value="@Model.Id" />
                
                <div class="row g-3 align-items-center">
                    <div class="col-auto">
                        <label class="form-label visually-hidden">Adet</label>
                        <div class="input-group">
                            <button class="btn btn-outline-secondary" type="button" onclick="decrementQty()">-</button>
                            <input type="number" name="quantity" id="quantityInput" class="form-control text-center border-secondary" value="1" min="1" max="@Model.Stock" style="width: 60px;">
                            <button class="btn btn-outline-secondary" type="button" onclick="incrementQty()">+</button>
                        </div>
                    </div>
                    <div class="col">
                        <button type="submit" class="btn btn-custom-primary rounded-pill w-100 py-2 fw-bold" @(Model.Stock < 1 ? "disabled" : "")>
                            <i class="fas fa-shopping-basket me-2"></i>
                            @(Model.Stock < 1 ? "Tükendi" : "Sepete Ekle")
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Similar Products / Suggestion could go here -->
</div>

@section Scripts {
    <script>
        function incrementQty() {
            var input = document.getElementById('quantityInput');
            var max = parseInt(input.getAttribute('max'));
            var val = parseInt(input.value);
            if (val < max) input.value = val + 1;
        }
        function decrementQty() {
            var input = document.getElementById('quantityInput');
            var val = parseInt(input.value);
            if (val > 1) input.value = val - 1;
        }

        async function addToCart(event, form) {
            event.preventDefault();
            const formData = new FormData(form);
            const button = form.querySelector('button[type="submit"]');
            const originalContent = button.innerHTML;

            try {
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ekleniyor...';
                button.disabled = true;

                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: { 'Accept': 'application/json' }
                });
                
                if (response.redirected) {
                    window.location.href = response.url;
                    return;
                }

                if (response.ok) {
                    const result = await response.json();
                     if (result.success) {
                        const badge = document.querySelector('.badge.bg-danger');
                        if (badge) badge.textContent = result.cartCount;
                        
                        button.innerHTML = '<i class="fas fa-check"></i> Eklendi!';
                        button.classList.replace('btn-custom-primary', 'btn-success');
                        
                        setTimeout(() => {
                            button.innerHTML = originalContent;
                            button.classList.replace('btn-success', 'btn-custom-primary');
                            button.disabled = false;
                        }, 1500);
                    } else {
                        alert(result.message); // Show stock error
                        button.innerHTML = originalContent;
                        button.disabled = false;
                    }
                }
            } catch (error) {
                console.error(error);
                button.innerHTML = 'Hata';
                setTimeout(() => { button.innerHTML = originalContent; button.disabled = false; }, 2000);
            }
        }
    </script>
}
